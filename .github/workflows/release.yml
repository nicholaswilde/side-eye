name: Release

permissions:
  contents: write

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get_version.outputs.version }}
    steps:
      - uses: actions/checkout@v4
      - name: Get version
        id: get_version
        run: |
          if [[ "$GITHUB_REF" == refs/tags/v* ]]; then
            echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          else
            echo "version=$GITHUB_REF_NAME" >> $GITHUB_OUTPUT
          fi
      # - name: Check version matches Cargo.toml
      #   run: |
      #     if [[ "$GITHUB_REF" == refs/tags/v* ]]; then
      #       cargo_version=$(grep "^version =" host/Cargo.toml | head -n1 | cut -d'"' -f2)
      #       tag_version="${GITHUB_REF#refs/tags/v}"
      #       if [[ "$tag_version" != "$cargo_version" ]]; then
      #         echo "Tag version ($tag_version) does not match host/Cargo.toml version ($cargo_version)"
      #         exit 1
      #       fi
      #     else
      #       echo "Not a tag reference, skipping version match check."
      #     fi
      - name: Create GitHub release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create ${{ github.ref_name }} \
            --draft \
            --title "v${{ steps.get_version.outputs.version }}" \
            --generate-notes

  build-host-packages:
    name: Build Host Packages
    needs: create-release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      - name: Install libudev
        run: sudo apt-get update && sudo apt-get install -y libudev-dev
      - name: Install Packaging Tools
        run: |
          cargo install cargo-deb
          cargo install cargo-generate-rpm
      - name: Setup Custom Cross Image
        if: matrix.build == 'linux-armv6'
        run: |
          # Create the Dockerfile on the fly
          echo "FROM ghcr.io/cross-rs/arm-unknown-linux-gnueabihf:main" > Dockerfile.custom
          echo "USER root" >> Dockerfile.custom
          echo "RUN apt-get update && apt-get install -y binutils-arm-linux-gnueabihf" >> Dockerfile.custom
          
          # Create Cross.toml on the fly
          echo "[target.arm-unknown-linux-gnueabihf]" > Cross.toml
          echo "dockerfile = \"./Dockerfile.custom\"" >> Cross.toml
      - name: Build Release
        run: cargo build --release --locked
        working-directory: host
      - name: Build Debian Package
        run: cargo deb
        working-directory: host
      - name: Build RPM Package
        run: cargo generate-rpm
        working-directory: host
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: host-packages
          path: |
            host/target/debian/*.deb
            host/target/generate-rpm/*.rpm
#      - name: Upload to Release
#        uses: softprops/action-gh-release@v2
#        if: github.ref_type == 'tag'
#        with:
#          files: |
#            host/target/debian/*.deb
#            host/target/generate-rpm/*.rpm
#          draft: true

  build-host-cross:
    name: Build Host Cross
    needs: create-release
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        target:
          - x86_64-unknown-linux-musl
          - aarch64-unknown-linux-musl
          - armv7-unknown-linux-musleabihf
          - arm-unknown-linux-gnueabihf
    steps:
      - uses: actions/checkout@v4
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}
      - name: Install Cross
        run: cargo install cross --git https://github.com/cross-rs/cross.git
      - name: Build
        run: cross build --release --target ${{ matrix.target }}
        working-directory: host
      - name: Build archive
        run: |
          staging="side-eye-host-${{ needs.create-release.outputs.version }}-${{ matrix.target }}"
          mkdir -p "$staging"
          cp host/target/${{ matrix.target }}/release/side-eye-host "$staging/"
          cp README.md LICENSE "$staging/"
          tar czf "$staging.tar.gz" "$staging"
          sha256sum "$staging.tar.gz" > "$staging.tar.gz.sha256"
          echo "ASSET=$staging.tar.gz" >> $GITHUB_ENV
          echo "ASSET_SUM=$staging.tar.gz.sha256" >> $GITHUB_ENV
#      - name: Upload to Release
#        uses: softprops/action-gh-release@v2
#        if: github.ref_type == 'tag'
#        with:
#          files: |
#            ${{ env.ASSET }}
#            ${{ env.ASSET_SUM }}
#          draft: true
